<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Avatar Widget ãƒ†ã‚¹ãƒˆ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #1a1a1a;
      margin-bottom: 10px;
      font-size: 32px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 16px;
    }
    .widget-wrapper {
      border: 3px solid #3B82F6;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 30px;
      background: #f8f9fa;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
      min-height: 350px;
    }
    .controls {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    .control-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #333;
      font-size: 14px;
    }
    input[type="text"] {
      width: 100%;
      max-width: 500px;
      padding: 10px 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    input[type="text"]:focus {
      outline: none;
      border-color: #3B82F6;
    }
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    button {
      padding: 12px 24px;
      background: #3B82F6;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:hover {
      background: #2563EB;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }
    button:active {
      transform: translateY(0);
    }
    button.secondary {
      background: #10B981;
    }
    button.secondary:hover {
      background: #059669;
    }
    .status {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      border-left: 4px solid #3B82F6;
      font-size: 14px;
      min-height: 50px;
    }
    .status.success {
      border-left-color: #10B981;
      background: #f0fdf4;
    }
    .status.error {
      border-left-color: #DC3545;
      background: #fef2f2;
    }
    .status.info {
      border-left-color: #3B82F6;
      background: #eff6ff;
    }
    .code-block {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      overflow-x: auto;
      margin-top: 20px;
    }
    .code-block code {
      display: block;
      white-space: pre;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¤– Avatar Widget ãƒ†ã‚¹ãƒˆ</h1>
    <p class="subtitle">scriptã‚¿ã‚°ã§å°å…¥ã—ãŸAvatar Widgetã®å‹•ä½œç¢ºèª</p>
    
    <div class="controls">
      <div class="control-group">
        <label>API Key (Gemini):</label>
        <input type="text" id="google-key-input" placeholder="AIza..." />
      </div>
      <div class="control-group">
        <label>API URL:</label>
        <input type="text" id="api-url-input" value="http://localhost:3000" />
      </div>
      <div class="button-group">
        <button onclick="initWidget()">Widgetã‚’åˆæœŸåŒ–</button>
        <button onclick="sendTestMessage()" class="secondary">ãƒ†ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡</button>
        <button onclick="removeWidget()" style="background: #DC3545;">Widgetã‚’å‰Šé™¤</button>
      </div>
    </div>

    <div class="status" id="status">
      <strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> æº–å‚™ä¸­... Widgetã‚’åˆæœŸåŒ–ã—ã¦ãã ã•ã„ã€‚
    </div>

    <div class="widget-wrapper" id="widget-container">
      <!-- Widget will be inserted here -->
    </div>

    <div class="code-block">
      <code id="code-display">// Widgetè¦ç´ ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</code>
    </div>
  </div>

  <!-- Avatar Widget Script -->
  <script src="/avatar-widget.js"></script>
  
  <script>
    let widget = null;
    const statusDiv = document.getElementById('status');
    const widgetContainer = document.getElementById('widget-container');
    const codeDisplay = document.getElementById('code-display');

    function updateStatus(message, type = 'info') {
      statusDiv.className = `status ${type}`;
      statusDiv.innerHTML = `<strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> ${message}`;
    }

    function updateCode() {
      const googleKey = document.getElementById('google-key-input').value;
      const apiUrl = document.getElementById('api-url-input').value;
      const code = `<avatar-widget
  google-key="${googleKey || 'your-google-api-key'}"
  api-url="${apiUrl || 'http://localhost:3000'}"
  ai-service="google"
  ai-model="gemini-2.5-flash"
  model-type="live2d"
  character-name="ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ"
  width="800px"
  height="500px"
  position="relative"
></avatar-widget>`;
      codeDisplay.textContent = code;
    }

    function initWidget() {
      // Remove existing widget
      if (widget) {
        widget.remove();
      }

      const googleKey = document.getElementById('google-key-input').value;
      const apiUrl = document.getElementById('api-url-input').value || 'http://localhost:3000';

      if (!googleKey) {
        updateStatus('âš ï¸ Gemini API Keyã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      updateStatus('ğŸ”„ Widgetã‚’åˆæœŸåŒ–ä¸­...', 'info');

      // Create widget element
      widget = document.createElement('avatar-widget');
      widget.setAttribute('google-key', googleKey);
      widget.setAttribute('api-url', apiUrl);
      widget.setAttribute('ai-service', 'google');
      widget.setAttribute('ai-model', 'gemini-2.5-flash');
      widget.setAttribute('model-type', 'live2d');
      widget.setAttribute('character-name', 'ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ');
      widget.setAttribute('width', '800px');
      widget.setAttribute('height', '500px');
      widget.setAttribute('position', 'relative');

      // Event listeners
      widget.addEventListener('ready', (e) => {
        updateStatus('âœ… Widgetæº–å‚™å®Œäº†ï¼ä¼šè©±ã‚’é–‹å§‹ã§ãã¾ã™ã€‚', 'success');
        console.log('Widget ready:', e.detail);
      });

      widget.addEventListener('message-sent', (e) => {
        updateStatus(`ğŸ“¤ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡: "${e.detail.message}"`, 'info');
        console.log('Message sent:', e.detail);
      });

      widget.addEventListener('message-received', (e) => {
        updateStatus(`ğŸ“¥ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡: "${e.detail.message.substring(0, 50)}..."`, 'success');
        console.log('Message received:', e.detail);
      });

      widget.addEventListener('error', (e) => {
        updateStatus(`âŒ ã‚¨ãƒ©ãƒ¼: ${e.detail.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`, 'error');
        console.error('Widget error:', e.detail);
      });

      // Append to container
      widgetContainer.appendChild(widget);
      updateCode();

      // Wait a bit for widget to initialize
      setTimeout(() => {
        if (widget) {
          if (widget.shadowRoot) {
            updateStatus('âœ… Widgetè¦ç´ ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚iframeã®èª­ã¿è¾¼ã¿ã‚’å¾…ã£ã¦ã„ã¾ã™...', 'info');
          } else {
            updateStatus('âš ï¸ Widgetè¦ç´ ã¯ä½œæˆã•ã‚Œã¾ã—ãŸãŒã€shadowRootãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'info');
          }
        }
      }, 500);
    }

    function sendTestMessage() {
      if (!widget) {
        updateStatus('âš ï¸ ã¾ãšWidgetã‚’åˆæœŸåŒ–ã—ã¦ãã ã•ã„', 'error');
        return;
      }

      // Check if sendMessage method exists
      if (typeof widget.sendMessage !== 'function') {
        updateStatus('âš ï¸ sendMessageãƒ¡ã‚½ãƒƒãƒ‰ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚Widgetã®åˆæœŸåŒ–ã‚’å¾…ã£ã¦ã„ã¾ã™...', 'error');
        // Try again after a short delay
        setTimeout(() => {
          if (typeof widget.sendMessage === 'function') {
            sendTestMessage();
          } else {
            updateStatus('âŒ Widgetã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
          }
        }, 1000);
        return;
      }

      const testMessages = [
        'ã“ã‚“ã«ã¡ã¯ï¼',
        'è‡ªå·±ç´¹ä»‹ã‚’ã—ã¦ãã ã•ã„',
        'ä»Šæ—¥ã®å¤©æ°—ã¯ï¼Ÿ',
        'ã‚ã‚ŠãŒã¨ã†'
      ];
      const randomMessage = testMessages[Math.floor(Math.random() * testMessages.length)];
      
      updateStatus(`ğŸ”„ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ä¸­: "${randomMessage}"`, 'info');
      
      try {
        widget.sendMessage(randomMessage);
      } catch (error) {
        updateStatus(`âŒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
        console.error('sendMessage error:', error);
      }
    }

    function removeWidget() {
      if (widget) {
        widget.remove();
        widget = null;
        updateStatus('ğŸ—‘ï¸ Widgetã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'info');
        codeDisplay.textContent = '// Widgetè¦ç´ ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™';
      }
    }

    // Update code display when inputs change
    document.getElementById('google-key-input').addEventListener('input', updateCode);
    document.getElementById('api-url-input').addEventListener('input', updateCode);

    // Initial code display
    updateCode();

    // Check if custom element is registered
    setTimeout(() => {
      if (customElements.get('avatar-widget')) {
        updateStatus('âœ… Avatar Widgetã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ', 'success');
      } else {
        updateStatus('âŒ Avatar Widgetã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error');
      }
    }, 1000);
  </script>
</body>
</html>

